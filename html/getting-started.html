<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Getting Started - Writing Anki Add-ons</title>
        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="intro.html">Introduction</a></li><li class="chapter-item expanded "><a href="getting-started.html" class="active"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="hooks-and-filters.html"><strong aria-hidden="true">2.</strong> Hooks and Filters</a></li><li class="chapter-item expanded "><a href="monkey-patching.html"><strong aria-hidden="true">3.</strong> Monkey Patching</a></li><li class="chapter-item expanded "><a href="features-and-debugging.html"><strong aria-hidden="true">4.</strong> Features and Debugging</a></li><li class="chapter-item expanded "><a href="sharing.html"><strong aria-hidden="true">5.</strong> Sharing Add-ons</a></li><li class="chapter-item expanded "><a href="porting2.0.html"><strong aria-hidden="true">6.</strong> Porting 2.0 Add-ons</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Writing Anki Add-ons</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/ankitects/addon-docs/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="getting-started"><a class="header" href="#getting-started">Getting Started</a></h1>
<ul>
<li><a href="#support">Support</a></li>
<li><a href="#ide--type-hints">IDE &amp; Type Hints</a></li>
<li><a href="#add-on-folders">Add-on folders</a></li>
<li><a href="#a-simple-add-on">A Simple Add-On</a></li>
<li><a href="#the-collection">The Collection</a></li>
<li><a href="#readingwriting-objects">Reading/Writing Objects</a></li>
<li><a href="#the-database">The Database</a></li>
</ul>
<h2 id="support"><a class="header" href="#support">Support</a></h2>
<p>This document contains some hints to get you started, but it is not a
comprehensive guide. To actually write an add-on, you will need to
familiarize yourself with Ankiâ€™s source code, and the source code of
other add-ons that do similiar things to what you are trying to
accomplish.</p>
<p>Because of our limited resources, <strong>no official support is available for
add-on writing</strong>. If you have any questions, you will either need to
find the answers yourself in the source code, or post your questions on
the <a href="https://forums.ankiweb.net/c/development/12">development forum</a>.</p>
<p>You can also use the add-on forum to request someone write an add-on for
you. You may need to offer some money before anyone becomes interested
in helping you.</p>
<h2 id="ide--type-hints"><a class="header" href="#ide--type-hints">IDE &amp; Type Hints</a></h2>
<p>The free community edition of PyCharm has good out of the box support
for Python: <a href="https://www.jetbrains.com/pycharm/">https://www.jetbrains.com/pycharm/</a>. You can also use other
editors like Visual Studio Code, but the instructions in this section
will cover PyCharm.</p>
<p>Over the last year, Ankiâ€™s codebase has been updated to add type hints to almost
all of the code. These type hints make development easier, by providing better
code completion, and by catching errors using tools like mypy. As an add-on
author, you can take advantage of this type hinting as well.</p>
<p>To get started with your first add-on:</p>
<ul>
<li>
<p>Open PyCharm and create a new project.</p>
</li>
<li>
<p>Right click/ctrl+click on your project on the left and create a new
Python package called &quot;myaddon&quot;</p>
</li>
</ul>
<p>Now youâ€™ll need to fetch Ankiâ€™s bundled source code so you can get type
completion. As of Anki 2.1.24, these are available on PyPI. <strong>You will need to
be using a 64 bit version of Python, version 3.8 or 3.9, or the commands below
will fail</strong>. To install Anki via PyCharm, click on Python Console in the bottom
left and type the following in:</p>
<pre><code class="language-python">import subprocess

subprocess.check_call([&quot;pip3&quot;, &quot;install&quot;, &quot;--upgrade&quot;, &quot;pip&quot;])
subprocess.check_call([&quot;pip3&quot;, &quot;install&quot;, &quot;mypy&quot;, &quot;aqt&quot;])
</code></pre>
<p>Hit enter and wait. Once it completes, you should now have code completion.</p>
<p>If you get an error, you are probably not using a 64 bit version of Python,
or your Python version is not 3.8 or 3.9. Try running the commands above
with &quot;-vvv&quot; to get more info.</p>
<p>After installing, try out the code completion by double clicking on the
<code>__init__.py</code> file. If you see a spinner down the bottom, wait for it to
complete. Then type in:</p>
<pre><code class="language-python">from anki import hooks
hooks.
</code></pre>
<p>and you should see completions pop up.</p>
<p><strong>Please note that you can not run your add-on from within PyCharm - you
will get errors.</strong> Add-ons need to be run from within Anki, which is
covered in the next section.</p>
<p>You can use mypy to type-check your code, which will catch some cases
where youâ€™ve called Anki functions incorrectly. Click on Terminal in the
bottom left, and type 'mypy myaddon'. After some processing, it will show
a success or tell you any mistakes youâ€™ve made. For example, if you
specified a hook incorrectly:</p>
<pre><code class="language-python">from aqt import gui_hooks

def myfunc() -&gt; None:
  print(&quot;myfunc&quot;)

gui_hooks.reviewer_did_show_answer.append(myfunc)
</code></pre>
<p>Then mypy will report:</p>
<pre><code>myaddon/__init__.py:5: error: Argument 1 to &quot;append&quot; of &quot;list&quot; has incompatible type &quot;Callable[[], Any]&quot;; expected &quot;Callable[[Card], None]&quot;
Found 1 error in 1 file (checked 1 source file)
</code></pre>
<p>Which is telling you that the hook expects a function which takes a card as
the first argument, eg</p>
<pre><code class="language-python">from anki.cards import Card

def myfunc(card: Card) -&gt; None:
  print(&quot;myfunc&quot;)
</code></pre>
<p>Mypy has a &quot;check_untyped_defs&quot; option that will give you some type checking
even if your own code lacks type hints, but to get the most out of it, you will
need to add type hints to your own code. This can take some initial time, but
pays off in the long term, as it becomes easier to navigate your own code, and
allows you to catch errors in parts of the code you might not regularly exercise
yourself. It is also makes it easier to check for any problems caused by updating
to a newer Anki version.</p>
<p>If you have a large existing add-on, you may wish to look into tools like monkeytype
to automatically add types to your code.</p>
<details>
<summary>Monkeytype</summary>
To use monkeytype with an add-on called 'test', you could do something like the following:
<pre><code class="language-shell">% /usr/local/bin/python3.8 -m venv pyenv
% cd pyenv &amp;&amp; . bin/activate
(pyenv) % pip install aqt monkeytype
(pyenv) % monkeytype run bin/anki
</code></pre>
<p>Then click around in your add-on to gather the runtime type information, and close
Anki when you're done.</p>
<p>After doing so, you'll need to comment out any top-level actions (such as code modifying
menus outside of a function), as that will trip up monkeytype. Finally, you can
generate the modified files with:</p>
<pre><code class="language-shell">(pyenv) % PYTHONPATH=~/Library/Application\ Support/Anki2/addons21 monkeytype apply test
</code></pre>
</details>
<p>Here are some example add-ons that use type hints:</p>
<p><a href="https://github.com/ankitects/anki-addons/blob/master/demos/">https://github.com/ankitects/anki-addons/blob/master/demos/</a></p>
<h2 id="add-on-folders"><a class="header" href="#add-on-folders">Add-on folders</a></h2>
<p>You can access the top level add-ons folder by going to the
Tools&gt;Add-ons menu item in the main Anki window. Click on the View
Files button, and a folder will pop up. If you had no add-ons installed,
the top level add-ons folder will be shown. If you had an add-on
selected, the add-onâ€™s module folder will be shown, and you will need to
go up one level.</p>
<p>The add-ons folder is named &quot;addons21&quot;, corresponding to Anki 2.1. If
you have an &quot;addons&quot; folder, it is because you have previously used Anki
2.0.x.</p>
<p>Each add-on uses one folder inside the add-on folder. Anki looks for a
file called <code>__init__.py</code> file inside the folder, eg:</p>
<pre><code>addons21/my_addon/__init__.py
</code></pre>
<p>If <code>__init__.py</code> does not exist, Anki will ignore the folder.</p>
<p>When choosing a folder name, it is recommended to stick to a-z and 0-9
characters to avoid problems with Pythonâ€™s module system.</p>
<p>While you can use whatever folder name you wish for folders you create
yourself, when you download an add-on from AnkiWeb, Anki will use the
itemâ€™s ID as the folder name, such as:</p>
<pre><code>addons21/48927303923/__init__.py
</code></pre>
<p>Anki will also place a meta.json file in the folder, which keeps track
of the original add-on name, when it was downloaded, and whether itâ€™s
enabled or not.</p>
<p>You should not store user data in the add-on folder, as itâ€™s <a href="features-and-debugging.html#configuration">deleted
when the user upgrades an add-on</a>.</p>
<p>If you followed the steps in the IDE section above, you can either copy
your myaddon folder into Ankiâ€™s add-on folder to test it, or a Mac or
Linux, create a symlink from the folderâ€™s original location into your
add-ons folder.</p>
<h2 id="a-simple-add-on"><a class="header" href="#a-simple-add-on">A Simple Add-On</a></h2>
<p>Add the following to <code>my_first_addon/__init__.py</code> in your add-ons folder:</p>
<pre><code class="language-python"># import the main window object (mw) from aqt
from aqt import mw
# import the &quot;show info&quot; tool from utils.py
from aqt.utils import showInfo, qconnect
# import all of the Qt GUI library
from aqt.qt import *

# We're going to add a menu item below. First we want to create a function to
# be called when the menu item is activated.

def testFunction() -&gt; None:
    # get the number of cards in the current collection, which is stored in
    # the main window
    cardCount = mw.col.cardCount()
    # show a message box
    showInfo(&quot;Card count: %d&quot; % cardCount)

# create a new menu item, &quot;test&quot;
action = QAction(&quot;test&quot;, mw)
# set it to call testFunction when it's clicked
qconnect(action.triggered, testFunction)
# and add it to the tools menu
mw.form.menuTools.addAction(action)
</code></pre>
<p>Restart Anki, and you should find a 'test' item in the tools menu.
Running it will display a dialog with the card count.</p>
<p>If you make a mistake when entering in the plugin, Anki will show an
error message on startup indicating where the problem is.</p>
<h2 id="the-collection"><a class="header" href="#the-collection">The Collection</a></h2>
<p>All operations on a collection file are accessed via mw.col. Some basic
examples of what you can do follow. Please note that you should put
these in testFunction() as above. You canâ€™t run them directly in an
add-on, as add-ons are initialized during Anki startup, before any
collection or profile has been loaded.</p>
<p><strong>Get a due card:</strong></p>
<pre><code class="language-python">card = mw.col.sched.getCard()
if not card:
    # current deck is finished
</code></pre>
<p><strong>Answer the card:</strong></p>
<pre><code class="language-python">mw.col.sched.answerCard(card, ease)
</code></pre>
<p><strong>Edit a note (append &quot; new&quot; to the end of each field):</strong></p>
<pre><code class="language-python">note = card.note()
for (name, value) in note.items():
    note[name] = value + &quot; new&quot;
note.flush()
</code></pre>
<p><strong>Get card IDs for notes with tag x:</strong></p>
<pre><code class="language-python">ids = mw.col.find_cards(&quot;tag:x&quot;)
</code></pre>
<p><strong>Get question and answer for each of those ids:</strong></p>
<pre><code class="language-python">for id in ids:
    card = mw.col.getCard(id)
    question = card.q()
    answer = card.a()
</code></pre>
<p><strong>Adjust due dates of reviews</strong></p>
<pre><code class="language-python">from anki.consts import QUEUE_TYPE_REV
ids = mw.col.find_cards(&quot;is:due&quot;)
for id in ids:
    card = mw.col.getCard(id)
    if card.queue == QUEUE_TYPE_REV:
        card.due += 1
        card.flush()
</code></pre>
<p><strong>Reset the scheduler after any DB changes. Note that we call reset() on
the main window, since the GUI has to be updated as well:</strong></p>
<pre><code class="language-python">mw.reset()
</code></pre>
<p><strong>Import a text file into the collection</strong></p>
<pre><code class="language-python">from anki.importing import TextImporter
file = u&quot;/path/to/text.txt&quot;
# select deck
did = mw.col.decks.id(&quot;ImportDeck&quot;)
mw.col.decks.select(did)
# anki defaults to the last note type used in the selected deck
m = mw.col.models.byName(&quot;Basic&quot;)
deck = mw.col.decks.get(did)
deck['mid'] = m['id']
mw.col.decks.save(deck)
# and puts cards in the last deck used by the note type
m['did'] = did
mw.col.models.save(m)
# import into the collection
ti = TextImporter(mw.col, file)
ti.initMapping()
ti.run()
</code></pre>
<p>Almost every GUI operation has an associated function in anki, so any of
the operations that Anki makes available can also be called in an
add-on.</p>
<p>If you want to access the collection outside of the GUI, you can do so
with the following code:</p>
<pre><code class="language-python">from anki import Collection
col = Collection(&quot;/path/to/collection.anki2&quot;)
</code></pre>
<p>If you make any modifications to the collection outside of Anki, you
must make sure to call col.close() when youâ€™re done, or those changes
will be lost.</p>
<h2 id="readingwriting-objects"><a class="header" href="#readingwriting-objects">Reading/Writing Objects</a></h2>
<p>Most objects in Anki can be read and written via methods in pylib.</p>
<pre><code class="language-python">card = col.getCard(card_id)
card.ivl += 1
card.flush()
</code></pre>
<pre><code class="language-python">note = col.getNote(note_id)
note[&quot;Front&quot;] += &quot; hello&quot;
note.flush()
</code></pre>
<pre><code class="language-python">deck = col.decks.get(deck_id)
deck[&quot;name&quot;] += &quot; hello&quot;
col.decks.save(deck)

deck = col.decks.byName(&quot;Default hello&quot;)
...
</code></pre>
<pre><code class="language-python">config = col.decks.get_config(config_id)
config[&quot;new&quot;][&quot;perDay&quot;] = 20
col.decks.save(config)
</code></pre>
<pre><code class="language-python">notetype = col.models.get(notetype_id)
notetype[&quot;css&quot;] += &quot;\nbody { background: grey; }\n&quot;
col.models.save(note)

notetype = col.models.byName(&quot;Basic&quot;)
...
</code></pre>
<p>You should prefer these methods over directly accessing the database,
as they take care of marking items as requiring a sync, and they prevent
some forms of invalid data from being written to the database.</p>
<p>For locating specific cards and notes, col.find_cards() and
col.find_notes() is useful.</p>
<h2 id="the-database"><a class="header" href="#the-database">The Database</a></h2>
<p>:warning: You can easily cause problems by writing directly to the database.
Where possible, please use the methods mentioned above instead.</p>
<p>Ankiâ€™s DB object supports the following functions:</p>
<p><strong>scalar() returns a single item:</strong></p>
<pre><code class="language-python">showInfo(&quot;card count: %d&quot; % mw.col.db.scalar(&quot;select count() from cards&quot;))
</code></pre>
<p><strong>list() returns a list of the first column in each row, eg [1, 2,
3]:</strong></p>
<pre><code class="language-python">ids = mw.col.db.list(&quot;select id from cards limit 3&quot;)
</code></pre>
<p><strong>all() returns a list of rows, where each row is a list:</strong></p>
<pre><code class="language-python">ids_and_ivl = mw.col.db.all(&quot;select id, ivl from cards&quot;)
</code></pre>
<p><strong>execute() can also be used to iterate over a result set without
building an intermediate list. eg:</strong></p>
<pre><code class="language-python">for id, ivl in mw.col.db.execute(&quot;select id, ivl from cards limit 3&quot;):
    showInfo(&quot;card id %d has ivl %d&quot; % (id, ivl))
</code></pre>
<p><strong>execute() allows you to perform an insert or update operation. Use
named arguments with ?. eg:</strong></p>
<pre><code class="language-python">mw.col.db.execute(&quot;update cards set ivl = ? where id = ?&quot;, newIvl, cardId)
</code></pre>
<p>Note that these changes won't sync, as they would if you used the functions
mentioned in the previous section.</p>
<p><strong>executemany() allows you to perform bulk update or insert operations.
For large updates, this is much faster than calling execute() for each
data point. eg:</strong></p>
<pre><code class="language-python">data = [[newIvl1, cardId1], [newIvl2, cardId2]]
mw.col.db.executemany(same_sql_as_above, data)
</code></pre>
<p>As above, these changes won't sync.</p>
<p>Add-ons should never modify the schema of existing tables, as that may
break future versions of Anki.</p>
<p>If you need to store addon-specific data, consider using Ankiâ€™s
<a href="features-and-debugging.html#configuration">Configuration</a> support.</p>
<p>If you need the data to sync across devices, small options can be stored
within mw.col.conf. Please donâ€™t store large amounts of data there, as
itâ€™s currently sent on every sync.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="intro.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="hooks-and-filters.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="intro.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="hooks-and-filters.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
